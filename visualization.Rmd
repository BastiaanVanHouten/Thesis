---
title: "Visualization"
author: "Bastiaan"
date: "2023-09-20"
output: 
  html_document:
    latex_engine: xelatex
    keep_tex: true
---


```{r echo=FALSE }
# load packages
library(interactions)
library(readr)
library(dplyr)
library(broom)
library(ggplot2)
library(ggpubr)
library(car)
library(MASS)
library(stargazer)
library(tinytex)
library(lubridate)
library(sjPlot)
library(sjmisc)
library(sjlabelled)


chooseCRANmirror(graphics = FALSE)


install.packages('memisc', repos='http://cran.us.r-project.org')
library(memisc)

df <- read_csv("~/Master/Thesis/gen/data-preparation/output/thanos_endgame.csv", 
                           col_types = cols(imdb.com_releasedate = col_datetime(format = "%Y-%d-%m")))
```


# We noticed that the rankings for the movies before 2000 were not that accurate 
```{r echo=FALSE}
df_clean <- df %>%
  filter(imdb.com_year > 2000)
```

# Let's see if box office is related to average ranking 

```{ r echo=FALSE}

df_clean$Box.Office <- as.numeric(df_clean$Box.Office)

model_box_office <- lm(Avg_Rank_Third_Year ~ Box.Office, data = df_clean)
model_box_office_year_1 <- lm(Avg_Rank_First_Year ~ Box.Office, data = df_clean)
model_rank_release <- lm(rank_release ~ Box.Office, data = df_clean)

# print model 
summary(model_box_office)
summary(model_box_office_year_1)
summary(model_rank_release)

# Scatterplot for model_box_office
ggplot(df, aes(x = Box.Office, y = Avg_Rank_Third_Year)) +
  geom_point() +                # Add points
  geom_smooth(method = "lm") +  # Add a linear regression line
  labs(
    x = "Box Office",
    y = "Avg Rank Third Year",
    title = "Scatterplot of Avg Rank Third Year vs. Box Office"
  )

```

# Let's first check the average ranking per year of the movies
```{R echo = FALSE}
ggplot(df_clean, aes(x = imdb.com_year, y = Avg_Rank_Third_Year)) +
  geom_line(stat = "summary", fun = "mean", fill = "skyblue") +
  labs(title = "Average Avg_Rank_Third_Year.y by imdb.com_year",
       x = "imdb.com_year",
       y = "Average Avg_Rank_Third_Year.y") +
  theme_minimal()

```

<sub> only possible explanation that top 250 or etc. is a very difficult to get to. The movies that have been published the more competitive it is to have a movie that keeps remaining popular.Therefore, it is logical that the movies that are newer are less popular after three years. Nevertheless, it is very difficult to explain why these movies popularity dropped so much after 2011.  
# This would be the regression of the main analysis
<sub> to achieve homoskedacity we did filter out the movies that were before 2000. But we did not filter out outliners.  

```{r echo=FALSE}

df_clean$Metascore <- as.numeric(df_clean$Metascore)

# Replace NA values with zero in specific columns
df_clean$Nominee <- ifelse(is.na(df_clean$Nominee), 0, df_clean$Nominee)
df_clean$Winner <- ifelse(is.na(df_clean$Winner), 0, df_clean$Winner)
df_clean$imdb.com_remake <- ifelse(is.na(df_clean$imdb.com_remake), 0, df_clean$imdb.com_remake)
df_clean$simpson_index <- ifelse(is.na(df_clean$simpson_index), 0, df_clean$simpson_index)
df_clean$boxofficemojo.com_openingtheaters <- ifelse(is.na(df_clean$boxofficemojo.com_openingtheaters), 0, df_clean$boxofficemojo.com_openingtheaters)
df_clean$the_numbers_com_dirpower_rank <- ifelse(is.na(df_clean$the_numbers_com_dirpower_rank), 0, df_clean$the_numbers_com_dirpower_rank)
df_clean$Metascore <- ifelse(is.na(df_clean$Metascore), 0, df_clean$Metascore)
df_clean$Total_Star_Power <- ifelse(is.na(df_clean$Total_Star_Power), 0 , df_clean$Total_Star_Power)

# Apply log transformation with small_constant
small_constant <- 1e-10  # Define your small constant value

df_clean$log_Nominee <- log(df_clean$Nominee + small_constant)
df_clean$log_Winner <- log(df_clean$Winner + small_constant)
df_clean$log_remake <- log(df_clean$imdb.com_remake + small_constant)
df_clean$log_simpson_index <- log(df_clean$simpson_index + small_constant)
df_clean$log_op_theater <- log(df_clean$boxofficemojo.com_openingtheaters + small_constant)
df_clean$log_dir_power <- log(df_clean$the_numbers_com_dirpower_rank + small_constant)
df_clean$log_metascore <- log(df_clean$Metascore + small_constant)
df_clean$log_starpower <-log(df_clean$Total_Star_Power + small_constant)
df_clean$log_starpower <-log(df_clean$Total_Star_Power + small_constant)

# Create new columns for each year from 2000 to 2019
for (year in 2000:2019) {
  col_name <- as.character(year)  # Convert the year to a character
  df_clean[col_name] <- ifelse(df_clean$imdb.com_year == year, 1, 0)
}

# Seasonality
# Create a new column for each season
df_clean$Spring <- ifelse(month(df_clean$imdb.com_releasedate) %in% c(3, 4, 5), 1, 0)
df_clean$Summer <- ifelse(month(df_clean$imdb.com_releasedate) %in% c(6, 7, 8), 1, 0)
df_clean$Fall <- ifelse(month(df_clean$imdb.com_releasedate) %in% c(9, 10, 11), 1, 0)
df_clean$Winter <- ifelse(month(df_clean$imdb.com_releasedate) %in% c(12, 1, 2), 1, 0)


```


```{r echo = FALSE}

model_variables <- c(
  "Avg_Rank_Third_Year",
  "simpson_index",
  "boxofficemojo.com_openingtheaters",
  "imdb.com_runtime",
  "mpaa_numeric",
  "average_budget",
  "imdb.com_releasedate",
  "imdb.com_sequel",
  "imdb.com_spinoff",
  "log_remake",
  "imdb.com_basedonbook",
  "imdb.com_basedonbookseries",
  "imdb.com_basedonplay",
  "imdb.com_basedoncomic",
  "imdb.com_basedoncomicbook",
  "imdb.com_basedonnovel",
  "imdb.com_basedonshortstory",
  "log_Nominee",
  "log_Winner",
  "log_dir_power",
  "log_metascore",
  "log_starpower",
  "Action",
  "Adventure",
  "Comedy",
  "Fantasy",
  "Crime",
  "Drama",
  "Mystery",
  "Thriller",
  "Romance",
  "Sci.Fi",
  "Biography",
  "Sport",
  "War",
  "Family",
  "Musical",
  "History",
  "Horror",
  "Music",
  "Documentary",
  "Western",
  "Spring",
  "Summer",
  "Fall",
  "Winter",
  "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019"
)

df_clean_subset <- df_clean[model_variables]

# Create the main regression model
model <- lm(log(Avg_Rank_Third_Year) ~ simpson_index + 
                log(boxofficemojo.com_openingtheaters) + 
                log(imdb.com_runtime) + log(mpaa_numeric) + 
                log(average_budget) + 
                imdb.com_releasedate +
                imdb.com_sequel + 
                imdb.com_spinoff +
                log_remake +
                imdb.com_basedonbook + 
                imdb.com_basedonbookseries + 
                imdb.com_basedonplay + 
                imdb.com_basedoncomic + 
                imdb.com_basedoncomicbook + 
                imdb.com_basedonnovel + 
                imdb.com_basedonshortstory + 
                log_Nominee +
                log_Winner +
                log_dir_power +
                log_metascore + 
                log_starpower +
                 # Include all genre variables
                Action + Adventure + Comedy + Fantasy + Crime + Drama + Mystery + Thriller + Romance + Sci.Fi + Biography + Sport + War + Family + Musical + History + Horror + Music + Documentary + Western +
            # including seasonality
                Spring +
                Summer +
                Fall +
                Winter +
               # Adding the year dummy variables to the model (excluding 2000)
                `2001` + `2002` + `2003` + `2004` + `2005` + `2006` + `2007` + `2008` + `2009` + `2010` + `2011` + `2012` + `2013` + `2014` + `2015` + `2016` + `2017` + `2018` + `2019`,
            data = df_clean_subset)


# print model 
summary(model)
```

```{r echo=FALSE}

stargazer(model, type = "text")

mytable <- stargazer(model, type = "text", out = "mytable.tex")
cat("\\input{mytable.tex}")

mt <- tab_model(model)


write_html(mt, "mt.html")
```


