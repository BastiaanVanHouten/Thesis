---
title: "diff in diff study"
author: "Bastiaan"
date: "2023-10-02"
output: html_document
---

```{r echo=FALSE }
# load packages
library(interactions)
library(readr)
library(dplyr)
library(broom)
library(ggplot2)
library(ggpubr)
library(car)
library(MASS)


df <- read_csv("~/Master/Thesis/gen/data-preparation/output/thanos_endgame.csv", 
                           col_types = cols(imdb.com_releasedate = col_datetime(format = "%Y-%d-%m")))
```


# Going for the Diff in Diff analysis
<we first removed all ranks for the dates that were before the release of the movies 
```{r echo = FALSE}
df$treatment <- ifelse(df$simpson_index > 0.3627456, 1, 0)

# Add the treatment variable and imdb.com_releasedate to movie_ranks
movie_ranks <- movie_ranks %>%
  left_join(df %>% select(treatment, imdb.com_imdbid, imdb.com_releasedate), 
            by = c("Movie_ID" = "imdb.com_imdbid"))


# Convert imdb.com_releasedate to Date format (if not already)
movie_ranks <- movie_ranks %>%
  mutate(imdb.com_releasedate = as.Date(imdb.com_releasedate))

# Filter the dataset to keep only observations where Date is after imdb.com_releasedate
filtered_movie_ranks <- movie_ranks %>%
  filter(Date >= imdb.com_releasedate)

filtered_movie_ranks <- filtered_movie_ranks %>%
  filter(imdb.com_releasedate > 2003)


```

# Let's check for outliers
<we removed a few outliers> 
```{r echo = FALSE}
# Calculate z-scores for Rank
filtered_movie_ranks$z_score <- scale(filtered_movie_ranks$Rank)

# Define a threshold for acceptable z-scores (e.g., within 3 standard deviations)
threshold <- 30

# Identify outliers
outliers <- filtered_movie_ranks[abs(filtered_movie_ranks$z_score) > threshold, ]

# Create a filtered dataset without outliers
filtered_movie_ranks <- filtered_movie_ranks[abs(filtered_movie_ranks$z_score) <= threshold, ]

# Remove the z_score variable as it's no longer needed
filtered_movie_ranks$z_score <- NULL

```


< we are checking for a parallel trend> 

```{r echo = FALSE}
# Assuming your data frame is named movie_ranks

# Filter the data into treatment and control groups
treatment_group <- movie_ranks %>%
  filter(treatment == 1) %>%
  group_by(Date) %>%
  summarise(avg_rank = mean(Rank))


control_group <- filtered_movie_ranks %>%
  filter(treatment == 0) %>%
  group_by(Date) %>%
  summarise(avg_rank = mean(Rank))

```

```{r}
# Create the plot with facets
ggplot(combined_data, aes(x = Date, y = avg_rank, color = group)) +
  geom_line(size = 1) +
  labs(title = "Average Ranking Over Time",
       x = "Date/Year",
       y = "Average Ranking") +
  scale_color_manual(values = c("Treatment Group" = "blue", "Control Group" = "red")) +
  facet_grid(. ~ group) +
  theme_minimal()
```

```{r echo = FALSE}
library(ggplot2)

# Create the plot
ggplot() +
  geom_line(data = treatment_group, aes(x = Date, y = avg_rank, color = "Treatment Group"), size = 1) +
  geom_line(data = control_group, aes(x = Date, y = avg_rank, color = "Control Group"), size = 1) +
  labs(title = "Average Ranking Over Time",
       x = "Date/Year",
       y = "Average Ranking") +
  scale_color_manual(values = c("Treatment Group" = "blue", "Control Group" = "red")) +
  theme_minimal()
```
<there is a parallel trend but what happend in 200 to 2002? Therefore, we double checked the IMDB website on web.archive.org and looking at those dates thats when the platform became way more user friendly. The IMDB top 250 movie was for example also non existing by that time> 

#running diff in diff normal movie ranks
```{r}
movie_ranks$time_indicator <- as.integer(movie_ranks$Date >= as.Date("2015-02-01"))

model_diff <- lm(Rank ~ treatment * time_indicator, data = movie_ranks)

summary(model_diff)

```
# the coeffient is actually significant. Nevertheless, this includes the 'bad data'before 2003. Lets remove those data and run it again. 

```{r echo = FALSE}
filtered_movie_ranks$time_indicator <- as.integer(filtered_movie_ranks$Date >= as.Date("2015-02-01"))

model_diff_filtered <- lm(Rank ~ treatment * time_indicator, data = filtered_movie_ranks)

summary(model_diff_filtered)
```
# the results of this model mean that if we clean all movies that were released before 2003. we still get a significant result for the interaction. What is even more inresting and valuable that movies after 2015 are far less popular, movies in the treatmant group meaning they have higher than the average racial diversity are also less popular. But when we combine them they become more popular. So let's change a few things 

# Let's adjust the threshold for the treatment group. 
```{r}
df$hard_treatment <- ifelse(df$simpson_index > 0.4, 1, 0)

# Add the treatment variable and imdb.com_releasedate to movie_ranks
hard_treatment_movie_ranks <- movie_ranks %>%
  left_join(df %>% select(hard_treatment, imdb.com_imdbid, imdb.com_releasedate), 
            by = c("Movie_ID" = "imdb.com_imdbid"))


# Convert imdb.com_releasedate to Date format (if not already)
hard_treatment_movie_ranks <- hard_treatment_movie_ranks %>%
  mutate(imdb.com_releasedate = as.Date(imdb.com_releasedate))

# Filter the dataset to keep only observations where Date is after imdb.com_releasedate
hard_filtered_movie_ranks <- hard_treatment_movie_ranks %>%
  filter(Date >= imdb.com_releasedate)

hard_filtered_movie_ranks <- hard_filtered_movie_ranks %>%
  filter(imdb.com_releasedate > 2003)
```



```{r}
hard_treatment_movie_ranks$time_indicator <- as.integer(hard_treatment_movie_ranks$Date >= as.Date("2015-02-01"))

model_diff_hard <- lm(Rank ~ hard_treatment * time_indicator, data = hard_treatment_movie_ranks)

summary(model_diff_hard)

```

```{r}
hard_filtered_movie_ranks$time_indicator <- as.integer(hard_filtered_movie_ranks$Date >= as.Date("2015-02-01"))

model_diff_hard <- lm(Rank ~ hard_treatment * time_indicator, data = hard_filtered_movie_ranks)

summary(model_diff_hard)

```
